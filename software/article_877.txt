Подробнее о Sony PlayStation 4 Pro — первой 4K-консоли.
Скоро на рынок поступит PlayStation 4 Pro, которая впервые позволит исполнять игры в разрешении 4K. Как Sony удалось это осуществить, учитывая, что мощность GPU возросла не радикально — лишь в 2 с лишним раза, до 4,2 терафлопса? В беседе с Eurogamer архитектор приставки Марк Церни (Mark Cerny) поделился подробностями.
В целом PS4 Pro не относится к новому поколению систем: архитектура CPU осталась прежней, объём памяти почти не изменился — система призвана стать расширением существующей модели: оптимизированные для неё игры смогут выводиться в повышенном вплоть до 4K разрешении. При этом от разработчиков требуется минимум усилий, чтобы задействовать новые возможности. Например, оптимизации Days Gone для PS4 Pro потребовали труда лишь одного программиста. Sony утверждает, что в общем объёме усилий при создании игры полноценная оптимизация для PS4 Pro займёт лишь долю процента.
Для начала стоит сказать, что в PS4 Pro применена однокристальная система, произведённая по 16-нм нормам FinFET, вместо 28-нм в оригинальной консоли. Это позволило существенно нарастить производительность. Например, 8 ядер CPU Jaguar работают теперь на частоте 2,1 ГГц вместо 1,6 ГГц (рост мощности в 1,3 раза). На смену 18 вычислительным блокам Radeon GCN с частотой 800 МГц пришли 36 вычислительных блоков с частотой 911 МГц (рост мощности в 2,3 раза). Пропускная способность 8 Гбайт памяти GDDR5 увеличилась на 24 %, до 218 Гбайт/с. Вдобавок появился дополнительный гигабайт более медленной оперативной памяти DDR3.
Sony говорит, что результатом её умелого проектирования стала система, способная эффективно выводить на экран в 4 раза больше пикселей, но при этом идеально совместимая более чем с 700 играми для оригинальной PS4. Чтобы совместимость была максимальной, Sony просто удвоила размер GPU: в режиме совместимости компания отключает вторую половину вычислительных блоков GPU, так что система работает очень близко к оригиналу. Мощность CPU увеличилась не сильно (насколько позволил новый техпроцесс), причём Sony также приняла решение ради максимальной совместимости использовать старые и довольно слабые ядра AMD Jaguar. Переход на новые ядра CPU мог привести к проблемам в отдельных проектах. В играх, где частота кадров не фиксирована, Sony обещает прирост производительности.
Также компания, посчитав, что играм необходимо больше памяти, добавила гигабайт более медленной DDR3. На стандартной модели при переключении между ПО вроде Netflix и игрой приложение остаётся в памяти системы даже во время игрового процесса, из-за чего возможно мгновенное переключение на него. На PS4 Pro происходит несколько иной процесс: при переключении на игру, Netflix перемещается в более медленную память DRAM. Благодаря этому высвобождается почти гигабайт GDDR5. 512 Мбайт из этого дополнительного объёма могут использовать игры (то есть на PS4 Pro они могут использовать 5,5 Гбайт вместо 5 Гбайт), а остальное отведено для визуализации интерфейса консоли в разрешении 4K вместо 1080p.
Этим небольшим дополнительным объёмом памяти разработчики могут распоряжаться по своему усмотрению, но обычно он весь уходит на буфер кадра 4K, так что не стоит думать, что в повышенном разрешении PS4 Pro сможет обеспечить вывод более качественных текстур и ресурсов — они останутся теми же, что и на обычной PS4. Зато поддержка вывода игры в 4K не потребует особых дополнительных усилий разработчиков или скачивания объёмных DLC. Полноценная картинка 4K с текстурами повышенного качества остаётся прерогативой ПК (разумеется, в соответствующих играх вроде Rise of the Tomb Raider, Far Cry Primal или Gears of War 4, где все ресурсы оптимизированы под 4K).
Зато Sony в PS4 Pro изменила архитектуру GPU, использовав самое последнее поколение Polaris. Это не только позволило серьёзно нарастить производительность, но также обеспечило появление новых функций вроде технологии сжатия DCC (delta color compression), которая позволяет существенно уменьшить требования к пропускной способности памяти. Это очень важное новшество, учитывая более чем двукратный рост производительности GPU и куда меньший — пропускной способности GDDR5.
Другое улучшение — технология отсечения примитивов. Она повышает эффективность (особенно в таких задачах, как различные методы полноэкранного сглаживания) за счёт отбрасывания из конвейера обработки изображения слишком мелких треугольников. Также оптимизирована работа с 16-бит инструкциями при вычислениях с плавающей запятой. Если ранее 16-бит переменная в шейдерной программе занимала то же пространство, что и 32-бит, то теперь для 16-бит нужно вдвое меньше векторных регистров. Это в определённых задачах существенно влияет на эффективность, повышая число обрабатываемых инструкций. То есть в случае 16-бит вычислений пиковая производительность возрастает с 4,2 терафлопса до 8,4 терафлопса.
Sony также отмечает, что плодами её сотрудничества с AMD пользуются и ПК-игроки: многие функции, созданные специально для консоли PS4 и PS4 Pro затем появляются на рынке дискретных видеокарт. Так было, например, в случае с асинхронными вычислениями, которые создавались именно под PS4 и дают сейчас преимущество видеокартам AMD в режиме DX12. Марк Церни говорит, что AMD очень охотно сотрудничает и консоли подчас даже получают новые функции раньше дискретных GPU.
В случае PS4 Pro в GPU есть новшества, которые пока не реализованы в архитектуре Polaris и появятся, вероятно, в Vega в следующем году. Это более эффективная работа с 16-бит инструкциями, о чём уже говорилось, и весьма продвинутый планировщик задач, который призван также повысить эффективность за счёт более интеллектуального распределения нагрузки. Этот распределитель задач не только приносит принципиальные улучшения в скорости работы тесселяции, как в Polaris, но вдобавок ускоряет рендеринг в сценах со множеством мелких объектов.
Но и это не всё: в чипе для PS4 Pro используются специальные блоки, созданные для консоли Sony и позволяющие ей прыгнуть выше головы. Сегодня технологии полноэкранного сглаживания вроде FXAA или SMAA имеют свои ограничения, и именно в этой области Sony постаралась решить проблему, представив ID-буфер, куда отдельный аппаратный блок записывает идентификатор объекта для максимально точного определения границ, которые необходимо сглаживать. Он полностью аппаратный и записывает данные одновременно с Z-буфером. В результате впервые объекты, их координаты и даже отдельные треугольники могут точно отслеживаться между кадрами. Современные GPU этого не умеют без сильного снижения производительности.
Использование этого буфера позволяет относительно малыми ресурсами с помощью геометрического рендеринга создавать 4K-картинку, частично используя текстуры и эффекты отражений в разрешении 1080p (такой метод применяется в Infamous First Light для PS4 Pro). Есть и более качественный и более требовательный к ресурсам метод поклеточного рендеринга. Он тоже позволяет создавать близкое к 4K изображение с экономией ресурсов за счёт новых качественных и экономных методов полноэкранного сглаживания на основе данных с предыдущих кадров.
При этом, по словам Sony, интеграция этих и других методов улучшения разрешения и графики в играх не требует существенных усилий разработчиков, тем более что японская компания предоставляет примеры кода. Большинство игр с оптимизациями для PS4 Pro будут исполняться в повышенном разрешении 1800p или даже 2160p на соответствующих телевизорах.
В некоторых играх используется полноценный рендеринг с динамическим разрешением (обычно в пределах 80–90 % от 4K), меняющимся в зависимости от сложности сцены и нагрузки. Но и в этом случае использование ID-буфера позволяет добиться существенных плюсов. Есть и игры (например, Paragon), в которых разработчики на PS4 Pro предпочли просто улучшить графику, частоту кадров и визуальные эффекты, оставив разрешение 1080p. Но последний подход не получит особого распространения: Sony стимулирует разработчиков оптимизировать игры прежде всего для поддержки повышенных разрешений для 4K-телевизоров. Владельцы обычных HDTV в большинстве случаев получат более качественное полноэкранное сглаживание (хотя есть и исключения вроде Paragon, Tomb Raider или Mass Effect Andromeda, где предусмотрены режимы 1080p с улучшенными эффектами и качеством отрисовки).
В целом, PS4 Pro с ценой $400 против $300 за обычную PS4 впечатляет. Не каждая игра идеально оптимизирована под вывод 4K-разрешений, но уже сейчас можно видеть хорошие результаты и примеры использования разработчиками собственных методов оптимизации 4K (например, Spider-Man и For Honor). А в будущем можно ждать, что ID-буфер, другие архитектурные новшества и повышенная мощность PS4 Pro будут использоваться разработчиками ещё эффективнее.
Разумеется, существенный плюс получат VR-проекты благодаря повышенной производительности PS4 Pro и аппаратной поддержке изменения разрешений (когда на периферии зрения кадр визуализируется в пониженном разрешении). Это позволит заметно улучшить производительность в играх для PS VR второго поколения без заметного влияния на качество изображения в шлеме.